name: TurboGo Auto Release

on:
  push:
    branches:
      - main

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: Set up Git
        run: |
          git config user.name "Dziqha"
          git config user.email "abdurrohmanhaadziq@gmail.com"

      - name: Get latest tag
        id: get_tag
        run: |
          TAG=$(git tag | sort -V | tail -n1)
          if [ -z "$TAG" ]; then TAG="v0.0.0"; fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Detect version bump type
        id: version_type
        run: |
          MSG=$(git log -1 --pretty=%B)
          if echo "$MSG" | grep -q "BREAKING CHANGE"; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif echo "$MSG" | grep -q "^feat!:" || echo "$MSG" | grep -q "^feat.*!"; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif echo "$MSG" | grep -q "^feat:"; then
            echo "type=minor" >> $GITHUB_OUTPUT
          elif echo "$MSG" | grep -q "^fix:"; then
            echo "type=patch" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Bump version (safe fallback)
        id: bump
        run: |
          OLD=${{ steps.get_tag.outputs.tag }}
          OLD=${OLD#v}

          IFS='.' read -r MAJOR MINOR PATCH <<< "$OLD"
          [ -z "$MAJOR" ] && MAJOR=0
          [ -z "$MINOR" ] && MINOR=0
          [ -z "$PATCH" ] && PATCH=0

          TYPE=${{ steps.version_type.outputs.type }}
          if [ "$TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
          elif [ "$TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1)); PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Create and push new tag
        run: |
          git tag ${{ steps.bump.outputs.new_tag }}
          git push origin ${{ steps.bump.outputs.new_tag }}

      - name: Push major alias tag
        run: |
          MAJOR=$(echo "${{ steps.bump.outputs.new_tag }}" | cut -d '.' -f1)
          git tag -f $MAJOR ${{ steps.bump.outputs.new_tag }}
          git push origin $MAJOR --force

      - name: Generate changelog from .changelog.md
        id: changelog
        run: |
          CURR_TAG=${{ steps.bump.outputs.new_tag }}
          
          echo "${CURR_TAG}" > changelog.txt
          echo "" >> changelog.txt
          
          # Check if .changelog.md exists and add its content
          if [ -f ".changelog.md" ]; then
            echo "üìã Release Notes" >> changelog.txt
            echo "" >> changelog.txt
            cat .changelog.md >> changelog.txt
          else
            echo "‚ö†Ô∏è No .changelog.md file found" >> changelog.txt
            echo "" >> changelog.txt
            echo "üßπ Updates" >> changelog.txt
            echo "- Release created without changelog file" >> changelog.txt
          fi

      - name: Add contributors to changelog
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          # Get previous tag for comparison
          PREV_TAG=$(git tag --sort=-creatordate | sed -n 2p)
          
          # Get unique contributors since last release
          if [ -n "$PREV_TAG" ]; then
            AUTHORS=$(git log $PREV_TAG..HEAD --format='%ae|%an' | sort -u)
          else
            AUTHORS=$(git log --format='%ae|%an' | sort -u)
          fi

          CONTRIBUTORS=""
          CONTRIBUTOR_COUNT=0
          
          # Process each author
          while IFS="|" read -r EMAIL NAME; do
            [ -z "$EMAIL" ] && continue
            
            # Try to get GitHub username from email
            USER=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/search/users?q=$EMAIL+in:email" | \
              jq -r '.items[0].login // empty')
            
            if [ -n "$USER" ]; then
              CONTRIBUTORS+="- [@$USER](https://github.com/$USER)\n"
            elif [ -n "$NAME" ]; then
              CONTRIBUTORS+="- $NAME\n"
            else
              CONTRIBUTORS+="- $EMAIL\n"
            fi
            CONTRIBUTOR_COUNT=$((CONTRIBUTOR_COUNT + 1))
          done <<< "$AUTHORS"

          # Add contributors section if we found any
          if [ $CONTRIBUTOR_COUNT -gt 0 ]; then
            echo "" >> changelog.txt
            echo "üë• Contributors" >> changelog.txt
            echo "" >> changelog.txt
            echo -e "$CONTRIBUTORS" >> changelog.txt
            echo "" >> changelog.txt
            echo "*Thank you to all $CONTRIBUTOR_COUNT contributor(s) who made this release possible!*" >> changelog.txt
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}
          tag_name: ${{ steps.bump.outputs.new_tag }}
          name: Release ${{ steps.bump.outputs.new_tag }}
          body_path: changelog.txt

      - name: Send Telegram Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION: ${{ steps.bump.outputs.new_tag }}
          TYPE: ${{ steps.version_type.outputs.type }}
        run: |
          TEXT="üìÜ *TurboGo Released ${VERSION}*%0Aüîñ Type: ${TYPE}%0Aüìù Changelog:%0A$(sed ':a;N;$!ba;s/\n/%0A/g' changelog.txt)"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="Markdown" \
            -d text="$TEXT"