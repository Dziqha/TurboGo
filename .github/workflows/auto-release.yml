name: TurboGo Auto Release

on:
  push:
    branches:
      - main

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: Set up Git
        run: |
          git config user.name "Dziqha"
          git config user.email "abdurrohmanhaadziq@gmail.com"

      - name: Get latest tag
        id: get_tag
        run: echo "tag=$(git describe --tags --abbrev=0 || echo 0.0.0)" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump
        run: echo "new_tag=v$(npx semver -i minor ${{ steps.get_tag.outputs.tag }})" >> $GITHUB_OUTPUT

      - name: Get commit type
        id: commit
        run: |
          TYPE=$(git log -1 --pretty=%s | sed -E 's/^([a-z]+):.*/\1/' | grep -E '^(feat|fix|chore|docs|refactor|ci|test)$' || echo "other")
          echo "type=$TYPE" >> $GITHUB_OUTPUT

      - name: Create tag and push
        run: |
          git tag ${{ steps.bump.outputs.new_tag }}
          git push origin ${{ steps.bump.outputs.new_tag }}

      - name: Generate changelog text with PR info
        id: changelog
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURR_TAG=${{ steps.bump.outputs.new_tag }}

          echo "${CURR_TAG}" > changelog.txt
          echo "" >> changelog.txt
          echo "üßπ Updates" >> changelog.txt

          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"%H|%s|%an")
          else
            COMMITS=$(git log --pretty=format:"%H|%s|%an")
          fi

          while IFS="|" read -r HASH MESSAGE AUTHOR; do
            PR_INFO=$(curl -s -H "Authorization: token $GH_TOKEN" \
              https://api.github.com/search/issues?q=$HASH+repo:$REPO) || continue
            PR_NUMBER=$(echo "$PR_INFO" | jq -r '.items[0].number // empty')
            PR_USER=$(echo "$PR_INFO" | jq -r '.items[0].user.login // empty')

            if [ -n "$PR_NUMBER" ] && [ -n "$PR_USER" ]; then
              echo "- $MESSAGE by @$PR_USER in #$PR_NUMBER" >> changelog.txt
            else
              echo "- $MESSAGE by @$AUTHOR in $HASH" >> changelog.txt
            fi
          done <<< "$COMMITS"

      - name: Resolve GitHub usernames
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          if PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null); then
            AUTHORS=$(git log $PREV_TAG..HEAD --format='%ae' | sort -u)
          else
            AUTHORS=$(git log --format='%ae' | sort -u)
          fi

          CONTRIBUTORS=""
          for EMAIL in $AUTHORS; do
            USER=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/search/users?q=$EMAIL+in:email | jq -r '.items[0].login // empty')
            if [ -n "$USER" ]; then
              CONTRIBUTORS+="[@$USER](https://github.com/$USER)\n"
            fi
          done

          if [ -n "$CONTRIBUTORS" ]; then
            echo "" >> changelog.txt
            echo "üë• Contributors" >> changelog.txt
            echo -e "$CONTRIBUTORS" >> changelog.txt
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}
          tag_name: ${{ steps.bump.outputs.new_tag }}
          name: Release ${{ steps.bump.outputs.new_tag }}
          body_path: changelog.txt

      - name: Send Telegram Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION: ${{ steps.bump.outputs.new_tag }}
        run: |
          TEXT="üìÜ *TurboGo Released ${VERSION}*%0Aüîñ Type: ${{ steps.commit.outputs.type }}%0Aüìù Changelog:%0A$(sed ':a;N;$!ba;s/\n/%0A/g' changelog.txt)"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="Markdown" \
            -d text="$TEXT"
